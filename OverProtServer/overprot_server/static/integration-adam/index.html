<html>

<head>
    <!-- Molstar CSS & JS -->
    <link crossorigin="anonymous" rel="stylesheet" type="text/css" href="https://www.ebi.ac.uk/pdbe/pdb-component-library/css/pdbe-molstar-1.2.0.css">
    <script type="text/javascript" src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/pdbe-molstar-plugin-1.2.0.js"></script>

    <!-- d3.js dependency script -->
    <script src="https://cdn.jsdelivr.net/npm/d3@5.9.2"></script>

    <!-- PDB Topology Viewer JS -->
    <script type="text/javascript" src="build/pdb-topology-viewer-plugin-2.0.0.js" defer></script>

    <!-- math.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.3/math.min.js" integrity="sha512-h6sl9arHHMneDTSQwIiJ6NUSx3/wGWKr9P25MQCnwmTsPMBHIscEtk/5k/zA+IOjvGQUuvn2003cRhX2BUpgqw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- OverProt CSS and scripts -->
    <!-- All links are copied from the overprot.ncbr.muni.cz pages -->
    <link crossorigin="anonymous" rel='stylesheet' type='text/css' href='https://overprot.ncbr.muni.cz/static/overprot-viewer/overprot-viewer.min.css'>
    <script type='text/javascript' src='https://overprot.ncbr.muni.cz/static/overprot-viewer/d3.v5.min.js'></script>
    <script type='text/javascript' src='https://overprot.ncbr.muni.cz/static/overprot-viewer/d3-selection-multi.v1.min.js'></script>
    <script type='text/javascript' src='https://overprot.ncbr.muni.cz/static/overprot-viewer/overprot-viewer.min.js'></script>


    <!-- Bootstrap selects CSS & JS, popper js is required -->
    <link crossorigin="anonymous" rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
    <script src="https://code.jquery.com/jquery-3.5.1.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.2.2/jquery.form.min.js" integrity="sha384-FzT3vTVGXqf7wRfy8k4BiyzvbNfeYjK+frTVqZeNDFl8woCbF0CYG6g2fMEFFo/i" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

    <!-- jQuery loading overlay -->
    <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js'></script>

    <link crossorigin="anonymous" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

    <script src="integration.js"></script>


    <style>
        .flex-container {
            display: flex;
        }

        #pdb-topology-viewer {
            /* minus navbar (56px) and overprot-wrapper*/
            height: calc(100vh - 70px - 200px);
            /*position: relative;
            width: calc(400px*1.0);
            height: 400px;
			margin-left: 0px;*/
        }

        #myViewer {
            /* minus navbar (56px) and overprot-wrapper*/
            height: calc(100vh - 70px - 200px);
            /*margin-left: 50px;
			width: 500px;
			position: relative;*/
        }

        #overprot-wrapper {

            height: 200px;
        }
    </style>

</head>

<body>
    <main>
        <!-- Works well, but cols make selects larger than necessary -->
        <!-- <nav class="navbar navbar-expand-lg navbar-dark bg-dark text-white"> -->
        <!-- <a class="navbar-brand h3" href="./index.html">Integrated Viewer</a> -->
        <!-- <form id="familyAndDomainForm" class="w-100 d-inline m-0"> -->
        <!-- <div class="form-row"> -->
        <!-- <label for="familiesSelector" class="col-sm-2 col-form-label col-form-label-sm">Protein family (CATH):</label> -->
        <!-- <div class="col"> -->
        <!-- <select id="familiesSelector" class="selectpicker form-control form-control-sm show-tick" data-live-search="true" data-size="5" data-hide-disabled="false"  onchange=""></select> -->
        <!-- </div> -->
        <!-- <label for="domainsSelector" class="col-sm-2 col-form-label col-form-label-sm">Protein domain:</label> -->
        <!-- <div class="col"> -->
        <!-- <select id="domainsSelector" class="selectpicker form-control form-control-sm show-tick" data-live-search="true" data-size="5" data-hide-disabled="false"  onchange=""></select> -->
        <!-- </div> -->
        <!-- <div class="col-1"> -->
        <!-- <button type="submit" id="submitFamilyAndDomainForm" class="btn btn-sm btn-primary w-100" disabled>Submit</button> -->
        <!-- </div> -->
        <!-- </div> -->
        <!-- </form> -->
        <!-- </nav> -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark text-white">
            <a class="navbar-brand" href="./index.html">Integrated Viewer</a>
            <div class="col">
                <div class='row'>
                    <div class='col'>
                        <div id='currentFamilyIdEle'></div>
                    </div>
                </div>
                <div class='row'>
                    <div class='col'>
                        <div id='currentDomainIdEle'></div>
                    </div>
                </div>
            </div>
            <form id="familyAndDomainForm" class="form-inline ml-auto my-0">
                <label for="familiesSelector" class="mx-3 pl-3">Protein family (CATH):</label>

                <select id="familiesSelector" class="mr-3 selectpicker form-control form-control-sm show-tick" data-live-search="true" data-size="5" data-hide-disabled="false" onchange="" data-width="auto"></select>
                <label for="domainsSelector" class="mx-3 pl-3">Protein domain:</label>
                <select id="domainsSelector" class="mr-3 selectpicker form-control form-control-sm show-tick" data-live-search="true" data-size="5" data-hide-disabled="false" onchange="" data-width="auto"></select>


                <button type="submit" id="submitFamilyAndDomainForm" class="btn btn-primary" disabled>Submit</button>

            </form>
        </nav>
        <div class="container-fluid">
            <div class="row">
                <div id="overprot-wrapper" class="col">
                </div>
            </div>

            <!-- PDB Topology Viewer container -->
            <div class="row no-gutters">
                <div id="pdb-topology-viewer" class="col-sm"></div>
                <div id="myViewer" class="col-sm"></div>
            </div>
            <!-- <div class="flex-container"> -->
            <!-- <div id="pdb-topology-viewer"></div> -->
            <!-- <div id="myViewer"></div> -->
            <!-- </div> -->
            <!-- </div> -->
    </main>

    <!-- Fetching data for options in selectors -->
    <script>
        $.LoadingOverlaySetup({
            background: "rgba(0, 0, 0, 0.8)",
            image: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><circle r="80" cx="500" cy="90"/><circle r="80" cx="500" cy="910"/><circle r="80" cx="90" cy="500"/><circle r="80" cx="910" cy="500"/><circle r="80" cx="212" cy="212"/><circle r="80" cx="788" cy="212"/><circle r="80" cx="212" cy="788"/><circle r="80" cx="788" cy="788"/></svg>',
            imageAnimation: "2.0s rotate_right",
            imageColor: "#FAFAFA",
            text: "Loading domain data...",
            textColor: "#D3D3D3",
            textResizeFactor: 0.3,
        });

        const instance = new IntegratedViewer();
        instance.parseUrl();
        if (!instance.wellcomePage) instance.showCurrentFamilyAndDomain();
        instance.bindFormSubmitListener();

        // on programmatic or user change of families selector, load domains select options and set value (either [0] or instance.domainId if page is with query params)
        $(instance.familiesSelectEle).on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
            // console.log(e, clickedIndex, isSelected, previousValue);
            instance.submitButton.disabled = true;
            const ele = $(instance.domainsSelectEle);
            $.LoadingOverlay('show');
            ele.attr('disabled', true).selectpicker('refresh');
            const selectedFamilyId = $(this).selectpicker('val');
            instance.loadDomainsSelectOptions(selectedFamilyId).then(() => {
                // if it was programmatic change && if it is a wellcome page OR if it was the user's change => select first domain in the list
                if ((clickedIndex === null && instance.wellcomePage) || clickedIndex !== null) {
                    // select [0] and refresh.....
                    try {
                        // Here it breaks if the user clicks on family selector many times and too fast: "... prop 'value' of undefined"
                        // E.g. 6.10.160.10 has empty domain list: https://overprot.ncbr.muni.cz/data/db/families/6.10.160.10/domains.json
                        // Or maybe we should just disable family selector as well until everything is ready? Seems not.						
                        console.log('selecting default domain option');
                        const defaultOption = ele[0].options[0].value;
                        ele.selectpicker('val', defaultOption);
                        instance.submitButton.disabled = false;
                        ele.attr('disabled', false);
                        ele.selectpicker('refresh');
                        ele.selectpicker('refresh');
                    } catch (error) {
                        console.log(error);
                    }
                    // if it was a programmatic change (on page with query params we set selectors values equal to that params)
                } else if (clickedIndex === null && !instance.wellcomePage) {
                    // select instance.domainId and refresh.....
                    console.log('selecting current domain option');
                    ele.selectpicker('val', instance.domainId);
                    instance.submitButton.disabled = false;
                    ele.attr('disabled', false);
                    ele.selectpicker('refresh');
                    ele.selectpicker('refresh');
                    // $.LoadingOverlay('hide');
                    // console.log('select instance.domainId', ele, instance.domainId);
                } else {
                    console.log('Something wrong happened');
                    console.log(e, clickedIndex, isSelected, previousValue);
                }
                setTimeout(() => {
                    $.LoadingOverlay('hide');
                }, 1000)
            });
        });

        instance.loadFamiliesSelectOptions().then(() => {
            const ele = $(instance.familiesSelectEle);
            if (instance.wellcomePage) {
                // select [0] and refresh.....
                // const defaultOption = ele[0].options[0].value;
                const defaultOption = instance.defaultFamilyId;
                ele.selectpicker('val', defaultOption);
                ele.selectpicker('refresh');
                ele.selectpicker('refresh');
                // console.log('select [0]', ele, defaultOption);
            } else {
                // select instance.familyId and refresh.....
                ele.selectpicker('val', instance.familyId);
                ele.selectpicker('refresh');
                ele.selectpicker('refresh');
                // console.log('select instance.domainId', ele, instance.domainId);
            }
        })

        if (!instance.wellcomePage) {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('dom loaded')
                instance.setData()
                    .then(() => {
                        instance.render1D();
                        instance.render2D();
                        instance.render3D();
                    });
            });
        }

    </script>

</body>

</html>